<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="preload" href="/_next/static/media/7b9ca6a1d31c5662-s.p.woff2" as="font" crossorigin="" type="font/woff2"/><link rel="preload" href="/_next/static/media/931105f8d96e7f26-s.p.woff2" as="font" crossorigin="" type="font/woff2"/><link rel="preload" href="/_next/static/media/c7a495162773a63f-s.p.woff2" as="font" crossorigin="" type="font/woff2"/><link rel="preload" href="/_next/static/media/fbdbe464b9e5cc95-s.p.woff2" as="font" crossorigin="" type="font/woff2"/><link rel="preload" href="/_next/static/media/2353a6662b834442-s.p.woff2" as="font" crossorigin="" type="font/woff2"/><link rel="stylesheet" href="/_next/static/css/41761c3dbdadce1b.css" data-precedence="next"/><link rel="stylesheet" href="/_next/static/css/bca99574867e3de4.css" data-precedence="next"/><link rel="stylesheet" href="/_next/static/css/62e03aa861d3a945.css" data-precedence="next"/><link rel="preload" as="script" fetchPriority="low" href="/_next/static/chunks/webpack-cbfacbf48d082482.js"/><script src="/_next/static/chunks/fd9d1056-2821b0f0cabcd8bd.js" async=""></script><script src="/_next/static/chunks/23-abf57663e0491ff6.js" async=""></script><script src="/_next/static/chunks/main-app-0e28269d753e21f7.js" async=""></script><script src="/_next/static/chunks/669-1310554c379159d6.js" async=""></script><script src="/_next/static/chunks/app/posts/layout-87563aa515b5fa49.js" async=""></script><title>Tripping on Code: Consequences of Multiple Enumeration of an IEnumerable</title><meta name="description" content="One of the many warnings that Resharper throws at us is Code Inspection: Possible multiple enumeration of IEnumerable. When I was younger…"/><link rel="icon" href="/favicon.ico" type="image/x-icon" sizes="16x16"/><meta name="next-size-adjust"/><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"/><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"/><link rel="manifest" href="/site.webmanifest"/><meta name="og:type" content="website"/><meta name="twitter:card" content="summary"/><meta name="twitter:creator" content="Avinash Krishna Kumar"/><script src="/_next/static/chunks/polyfills-78c92fac7aa8fdd8.js" noModule=""></script></head><body class="__className_f68def leading-7 w-2/3 max-w-2/3 mx-auto dark:bg-slate-900 dark:text-slate-200"><div style="margin-left:auto;margin-right:auto"><header class="my-8"><h1 class="__className_05000c text-3xl"><a style="box-shadow:none;text-decoration:none;color:inherit" href="/">Tripping on Code</a></h1></header><main class=""><main><h3 class="font-bold">Consequences of Multiple Enumeration of an IEnumerable</h3><p>January 02, 2021</p><div class="page_postBody__sSgeO"><p>One of the many warnings that Resharper throws at us is <em>Code Inspection: Possible multiple enumeration of IEnumerable</em>. When I was younger and much less experienced, this was one of those warnings that I never fully understood. Many of my methods returned IEnumerables rather than any of it's derivations. I started invoking <em>ToList</em> every time resharper complained, without completely understanding the reason for the warning. I understood that an IEnumerable could be lazily evaluated and that it could hurt performance to evaluate it again and again. I did not realize until recently that because of lazy evaluation, we could get vastly different results.</p>
<p>Consider the code below:</p>
<pre class="language-csharp"><code class="language-csharp"><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Linq</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Collections<span class="token punctuation">.</span>Generic</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Person</span>
<span class="token punctuation">{</span>
	<span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> Id <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Name <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> Age <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PersonGenerator</span>
<span class="token punctuation">{</span>
	<span class="token keyword">private</span> <span class="token class-name">Random</span> random <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">public</span> <span class="token return-type class-name">IEnumerable<span class="token punctuation">&#x3C;</span>Person<span class="token punctuation">></span></span> <span class="token function">GetRandomPeople</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> maxCount<span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token class-name"><span class="token keyword">var</span></span> count <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>random<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span>maxCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&#x3C;</span> count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
		<span class="token punctuation">{</span>
			<span class="token keyword">yield</span> <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Person</span>
            <span class="token punctuation">{</span>
                Id <span class="token operator">=</span> random<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">.</span>MaxValue<span class="token punctuation">)</span><span class="token punctuation">,</span>
                Age <span class="token operator">=</span> random<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token number">86</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Program</span>
<span class="token punctuation">{</span>
	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token class-name">PersonGenerator</span> personGenerator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">PersonGenerator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name"><span class="token keyword">var</span></span> randomPeople <span class="token operator">=</span> personGenerator<span class="token punctuation">.</span><span class="token function">GetRandomPeople</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name"><span class="token keyword">var</span></span> count1 <span class="token operator">=</span> randomPeople<span class="token punctuation">.</span><span class="token function">Count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name"><span class="token keyword">var</span></span> count2 <span class="token operator">=</span> randomPeople<span class="token punctuation">.</span><span class="token function">Count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"Count1 = </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">count1</span><span class="token punctuation">}</span></span><span class="token string">, Count2 = </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">count2</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>The code above outputs the following</p>
<pre><code>Count1 = 4, Count2 = 34
</code></pre>
<h2>Wait. What's happening here?</h2>
<p>The GetRandomPeople method uses yield return. This causes it to return a type which is lazily evaluated. Every time the Count() method is invoked, The GetRandomPeople method is invoked again. Since that method returns a random number of items, the counts are different for every enumeration of the IEnumerable.</p>
<p>The lazy evaluation of the IEnumerable is a very powerful feature, especially paired with a yield return, however to quote a tired old adage, "With great power comes great responsibility".</p>
<h3>How do I prevent this?</h3>
<ul>
<li>The first thing that should have been done is to realize that multiple enumeration was occuring and invoke ToList on it.</li>
<li>There is no reason for the GetRandomPeople method to either return an IEnumerable or use a yield return. The method should return
a <a href="https://docs.microsoft.com/en-us/dotnet/api/system.collections.generic.list-1?view=netcore-2.2">List</a>,
a <a href="https://docs.microsoft.com/en-us/dotnet/api/system.collections.objectmodel.readonlycollection-1?view=netcore-2.2">ReadOnlyCollection</a>
an <a href="https://docs.microsoft.com/en-us/dotnet/api/system.collections.immutable.immutablelist-1?view=netcore-2.2">ImmutableList</a> or
any other concrete collection implementation.</li>
</ul>
<p>Microsoft has published a set of <a href="https://docs.microsoft.com/en-us/dotnet/standard/design-guidelines/guidelines-for-collections">Guidelines for Collections</a> that is a must read for all developers.</p></div></main></main><footer class="">© <!-- -->2024<!-- --> Tripping on Code</footer></div><script src="/_next/static/chunks/webpack-cbfacbf48d082482.js" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0]);self.__next_f.push([2,null])</script><script>self.__next_f.push([1,"1:HL[\"/_next/static/media/7b9ca6a1d31c5662-s.p.woff2\",\"font\",{\"crossOrigin\":\"\",\"type\":\"font/woff2\"}]\n2:HL[\"/_next/static/media/931105f8d96e7f26-s.p.woff2\",\"font\",{\"crossOrigin\":\"\",\"type\":\"font/woff2\"}]\n3:HL[\"/_next/static/media/c7a495162773a63f-s.p.woff2\",\"font\",{\"crossOrigin\":\"\",\"type\":\"font/woff2\"}]\n4:HL[\"/_next/static/media/fbdbe464b9e5cc95-s.p.woff2\",\"font\",{\"crossOrigin\":\"\",\"type\":\"font/woff2\"}]\n5:HL[\"/_next/static/css/41761c3dbdadce1b.css\",\"style\"]\n6:HL[\"/_next/static/media/2353a6662b834442-s.p.woff2\",\"font\",{\"crossOrigin\":\"\",\"type\":\"font/woff2\"}]\n7:HL[\"/_next/static/css/bca99574867e3de4.css\",\"style\"]\n8:HL[\"/_next/static/css/62e03aa861d3a945.css\",\"style\"]\n"])</script><script>self.__next_f.push([1,"9:I[5751,[],\"\"]\nc:I[9275,[],\"\"]\ne:I[1343,[],\"\"]\nf:I[231,[\"669\",\"static/chunks/669-1310554c379159d6.js\",\"517\",\"static/chunks/app/posts/layout-87563aa515b5fa49.js\"],\"\"]\n11:I[6130,[],\"\"]\nd:[\"slug\",\"yield-return-random\",\"d\"]\n12:[]\n"])</script><script>self.__next_f.push([1,"0:[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/41761c3dbdadce1b.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\"}]],[\"$\",\"$L9\",null,{\"buildId\":\"zU87H2Yx3bLjEEuAcbVCg\",\"assetPrefix\":\"\",\"initialCanonicalUrl\":\"/posts/yield-return-random\",\"initialTree\":[\"\",{\"children\":[\"posts\",{\"children\":[[\"slug\",\"yield-return-random\",\"d\"],{\"children\":[\"__PAGE__?{\\\"slug\\\":\\\"yield-return-random\\\"}\",{}]}]}]},\"$undefined\",\"$undefined\",true],\"initialSeedData\":[\"\",{\"children\":[\"posts\",{\"children\":[[\"slug\",\"yield-return-random\",\"d\"],{\"children\":[\"__PAGE__\",{},[[\"$La\",\"$Lb\"],null],null]},[\"$\",\"$Lc\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"posts\",\"children\",\"$d\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$Le\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"styles\":[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/62e03aa861d3a945.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\"}]]}],null]},[[\"$\",\"div\",null,{\"style\":{\"marginLeft\":\"auto\",\"marginRight\":\"auto\"},\"children\":[[\"$\",\"header\",null,{\"className\":\"my-8\",\"children\":[\"$\",\"h1\",null,{\"className\":\"__className_05000c text-3xl\",\"children\":[\"$\",\"$Lf\",null,{\"style\":{\"boxShadow\":\"none\",\"textDecoration\":\"none\",\"color\":\"inherit\"},\"href\":\"/\",\"children\":\"Tripping on Code\"}]}]}],[\"$\",\"main\",null,{\"className\":\"\",\"children\":[\"$\",\"$Lc\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"posts\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$Le\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"styles\":null}]}],[\"$\",\"footer\",null,{\"className\":\"\",\"children\":[\"© \",2024,\" Tripping on Code\"]}]]}],null],null]},[[\"$\",\"html\",null,{\"lang\":\"en\",\"children\":[[\"$\",\"head\",null,{\"children\":[[\"$\",\"link\",null,{\"rel\":\"apple-touch-icon\",\"sizes\":\"180x180\",\"href\":\"/apple-touch-icon.png\"}],[\"$\",\"link\",null,{\"rel\":\"icon\",\"type\":\"image/png\",\"sizes\":\"32x32\",\"href\":\"/favicon-32x32.png\"}],[\"$\",\"link\",null,{\"rel\":\"icon\",\"type\":\"image/png\",\"sizes\":\"16x16\",\"href\":\"/favicon-16x16.png\"}],[\"$\",\"link\",null,{\"rel\":\"manifest\",\"href\":\"/site.webmanifest\"}],[\"$\",\"meta\",null,{\"name\":\"og:type\",\"content\":\"website\"}],[\"$\",\"meta\",null,{\"name\":\"twitter:card\",\"content\":\"summary\"}],[\"$\",\"meta\",null,{\"name\":\"twitter:creator\",\"content\":\"Avinash Krishna Kumar\"}]]}],[\"$\",\"body\",null,{\"className\":\"__className_f68def leading-7 w-2/3 max-w-2/3 mx-auto dark:bg-slate-900 dark:text-slate-200\",\"children\":[\"$\",\"$Lc\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$Le\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":[[\"$\",\"title\",null,{\"children\":\"404: This page could not be found.\"}],[\"$\",\"div\",null,{\"style\":{\"fontFamily\":\"system-ui,\\\"Segoe UI\\\",Roboto,Helvetica,Arial,sans-serif,\\\"Apple Color Emoji\\\",\\\"Segoe UI Emoji\\\"\",\"height\":\"100vh\",\"textAlign\":\"center\",\"display\":\"flex\",\"flexDirection\":\"column\",\"alignItems\":\"center\",\"justifyContent\":\"center\"},\"children\":[\"$\",\"div\",null,{\"children\":[[\"$\",\"style\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}\"}}],[\"$\",\"h1\",null,{\"className\":\"next-error-h1\",\"style\":{\"display\":\"inline-block\",\"margin\":\"0 20px 0 0\",\"padding\":\"0 23px 0 0\",\"fontSize\":24,\"fontWeight\":500,\"verticalAlign\":\"top\",\"lineHeight\":\"49px\"},\"children\":\"404\"}],[\"$\",\"div\",null,{\"style\":{\"display\":\"inline-block\"},\"children\":[\"$\",\"h2\",null,{\"style\":{\"fontSize\":14,\"fontWeight\":400,\"lineHeight\":\"49px\",\"margin\":0},\"children\":\"This page could not be found.\"}]}]]}]}]],\"notFoundStyles\":[],\"styles\":[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/bca99574867e3de4.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\"}]]}]}]]}],null],null],\"couldBeIntercepted\":false,\"initialHead\":[null,\"$L10\"],\"globalErrorComponent\":\"$11\",\"missingSlots\":\"$W12\"}]]\n"])</script><script>self.__next_f.push([1,"13:T273f,"])</script><script>self.__next_f.push([1,"\u003cp\u003eOne of the many warnings that Resharper throws at us is \u003cem\u003eCode Inspection: Possible multiple enumeration of IEnumerable\u003c/em\u003e. When I was younger and much less experienced, this was one of those warnings that I never fully understood. Many of my methods returned IEnumerables rather than any of it's derivations. I started invoking \u003cem\u003eToList\u003c/em\u003e every time resharper complained, without completely understanding the reason for the warning. I understood that an IEnumerable could be lazily evaluated and that it could hurt performance to evaluate it again and again. I did not realize until recently that because of lazy evaluation, we could get vastly different results.\u003c/p\u003e\n\u003cp\u003eConsider the code below:\u003c/p\u003e\n\u003cpre class=\"language-csharp\"\u003e\u003ccode class=\"language-csharp\"\u003e\u003cspan class=\"token keyword\"\u003eusing\u003c/span\u003e \u003cspan class=\"token namespace\"\u003eSystem\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eusing\u003c/span\u003e \u003cspan class=\"token namespace\"\u003eSystem\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eLinq\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eusing\u003c/span\u003e \u003cspan class=\"token namespace\"\u003eSystem\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eCollections\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eGeneric\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"token class-name\"\u003ePerson\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\u003cspan class=\"token keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"token return-type class-name\"\u003e\u003cspan class=\"token keyword\"\u003eint\u003c/span\u003e\u003c/span\u003e Id \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eget\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eset\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\t\u003cspan class=\"token keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"token return-type class-name\"\u003e\u003cspan class=\"token keyword\"\u003estring\u003c/span\u003e\u003c/span\u003e Name \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eget\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eset\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"token keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"token return-type class-name\"\u003e\u003cspan class=\"token keyword\"\u003eint\u003c/span\u003e\u003c/span\u003e Age \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eget\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eset\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"token class-name\"\u003ePersonGenerator\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\u003cspan class=\"token keyword\"\u003eprivate\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eRandom\u003c/span\u003e random \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token constructor-invocation class-name\"\u003eRandom\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\t\u003cspan class=\"token keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"token return-type class-name\"\u003eIEnumerable\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003ePerson\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token function\"\u003eGetRandomPeople\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003e\u003cspan class=\"token keyword\"\u003eint\u003c/span\u003e\u003c/span\u003e maxCount\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\u003cspan class=\"token class-name\"\u003e\u003cspan class=\"token keyword\"\u003evar\u003c/span\u003e\u003c/span\u003e count \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003erandom\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eNext\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003emaxCount\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\t\t\u003cspan class=\"token keyword\"\u003efor\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003e\u003cspan class=\"token keyword\"\u003evar\u003c/span\u003e\u003c/span\u003e i \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e i \u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003e count\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e i\u003cspan class=\"token operator\"\u003e++\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\t\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\t\u003cspan class=\"token keyword\"\u003eyield\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token constructor-invocation class-name\"\u003ePerson\u003c/span\u003e\n            \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n                Id \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e random\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eNext\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eint\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eMaxValue\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n                Age \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e random\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eNext\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e86\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eProgram\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\u003cspan class=\"token keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"token keyword\"\u003estatic\u003c/span\u003e \u003cspan class=\"token return-type class-name\"\u003e\u003cspan class=\"token keyword\"\u003evoid\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token function\"\u003eMain\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\u003cspan class=\"token class-name\"\u003ePersonGenerator\u003c/span\u003e personGenerator \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token constructor-invocation class-name\"\u003ePersonGenerator\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\t\t\u003cspan class=\"token class-name\"\u003e\u003cspan class=\"token keyword\"\u003evar\u003c/span\u003e\u003c/span\u003e randomPeople \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e personGenerator\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eGetRandomPeople\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e100\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\t\t\u003cspan class=\"token class-name\"\u003e\u003cspan class=\"token keyword\"\u003evar\u003c/span\u003e\u003c/span\u003e count1 \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e randomPeople\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eCount\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\t\t\u003cspan class=\"token class-name\"\u003e\u003cspan class=\"token keyword\"\u003evar\u003c/span\u003e\u003c/span\u003e count2 \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e randomPeople\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eCount\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\t\tConsole\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token interpolation-string\"\u003e\u003cspan class=\"token string\"\u003e$\"Count1 = \u003c/span\u003e\u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token expression language-csharp\"\u003ecount1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token string\"\u003e, Count2 = \u003c/span\u003e\u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token expression language-csharp\"\u003ecount2\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThe code above outputs the following\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eCount1 = 4, Count2 = 34\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2\u003eWait. What's happening here?\u003c/h2\u003e\n\u003cp\u003eThe GetRandomPeople method uses yield return. This causes it to return a type which is lazily evaluated. Every time the Count() method is invoked, The GetRandomPeople method is invoked again. Since that method returns a random number of items, the counts are different for every enumeration of the IEnumerable.\u003c/p\u003e\n\u003cp\u003eThe lazy evaluation of the IEnumerable is a very powerful feature, especially paired with a yield return, however to quote a tired old adage, \"With great power comes great responsibility\".\u003c/p\u003e\n\u003ch3\u003eHow do I prevent this?\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003eThe first thing that should have been done is to realize that multiple enumeration was occuring and invoke ToList on it.\u003c/li\u003e\n\u003cli\u003eThere is no reason for the GetRandomPeople method to either return an IEnumerable or use a yield return. The method should return\na \u003ca href=\"https://docs.microsoft.com/en-us/dotnet/api/system.collections.generic.list-1?view=netcore-2.2\"\u003eList\u003c/a\u003e,\na \u003ca href=\"https://docs.microsoft.com/en-us/dotnet/api/system.collections.objectmodel.readonlycollection-1?view=netcore-2.2\"\u003eReadOnlyCollection\u003c/a\u003e\nan \u003ca href=\"https://docs.microsoft.com/en-us/dotnet/api/system.collections.immutable.immutablelist-1?view=netcore-2.2\"\u003eImmutableList\u003c/a\u003e or\nany other concrete collection implementation.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eMicrosoft has published a set of \u003ca href=\"https://docs.microsoft.com/en-us/dotnet/standard/design-guidelines/guidelines-for-collections\"\u003eGuidelines for Collections\u003c/a\u003e that is a must read for all developers.\u003c/p\u003e"])</script><script>self.__next_f.push([1,"b:[\"$\",\"main\",null,{\"children\":[[\"$\",\"h3\",null,{\"className\":\"font-bold\",\"children\":\"Consequences of Multiple Enumeration of an IEnumerable\"}],[\"$\",\"p\",null,{\"children\":\"January 02, 2021\"}],[\"$\",\"div\",null,{\"className\":\"page_postBody__sSgeO\",\"dangerouslySetInnerHTML\":{\"__html\":\"$13\"}}]]}]\n10:[[\"$\",\"meta\",\"0\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}],[\"$\",\"meta\",\"1\",{\"charSet\":\"utf-8\"}],[\"$\",\"title\",\"2\",{\"children\":\"Tripping on Code: Consequences of Multiple Enumeration of an IEnumerable\"}],[\"$\",\"meta\",\"3\",{\"name\":\"description\",\"content\":\"One of the many warnings that Resharper throws at us is Code Inspection: Possible multiple enumeration of IEnumerable. When I was younger…\"}],[\"$\",\"link\",\"4\",{\"rel\":\"icon\",\"href\":\"/favicon.ico\",\"type\":\"image/x-icon\",\"sizes\":\"16x16\"}],[\"$\",\"meta\",\"5\",{\"name\":\"next-size-adjust\"}]]\na:null\n"])</script></body></html>